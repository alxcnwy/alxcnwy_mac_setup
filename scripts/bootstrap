#!/usr/bin/env bash
set -e

proj_root="$(pwd)"
proj_name="$(basename "$proj_root")"
script_dir="$(cd "$(dirname "${BASH_SOURCE[0]}")" && pwd)"
agents_src="$script_dir/../AGENTS.md"

# venv
if [ -d ".venv" ]; then
  echo ".venv already exists."
  read -r -p "Recreate virtualenv in .venv? [y/N] " answer
  case "$answer" in
    [Yy]*)
      echo "Recreating .venv..."
      rm -rf .venv
      python3 -m venv .venv
      ;;
    *)
      echo "Reusing existing .venv"
      ;;
  esac
else
  python3 -m venv .venv
fi
source .venv/bin/activate

# deps
pip install --upgrade pip wheel
pip install flask

# AGENTS.md (source of truth for agent behavior)
if [ -f "$agents_src" ]; then
  cp "$agents_src" "$proj_root/AGENTS.md"
else
  echo "Warning: AGENTS.md not found at $agents_src; skipping copy."
fi

# spec.md (lightweight project spec)
if [ ! -f "$proj_root/spec.md" ]; then
  cat > "$proj_root/spec.md" <<'EOF'
# Project Spec

## What are you building?
- One sentence summary:
- Who is it for:
- Why now:

## Scope (MVP)
- [ ] Core feature 1
- [ ] Core feature 2
- [ ] Nice-to-have

## Notes
- Constraints / assumptions:
- Open questions:
EOF
fi

# todo.md (scratchpad tasks)
if [ ! -f "$proj_root/todo.md" ]; then
  cat > "$proj_root/todo.md" <<'EOF'
# TODO

- [ ] First concrete task
- [ ] Second concrete task
- [ ] One tiny task you can do in 5 minutes

## Later / Someday
- [ ] Bigger idea to revisit
EOF
fi

# README.md (quick start at the top)
if [ ! -f "$proj_root/README.md" ]; then
  cat > "$proj_root/README.md" <<EOF
# $proj_name

Short one-sentence description of the project.

## Getting Started

1. Activate the virtualenv:

   \`\`\`bash
   source .venv/bin/activate
   \`\`\`

2. Run the app (adjust as needed):

   \`\`\`bash
   flask run
   \`\`\`

## Project Docs

- See \`spec.md\` for a lightweight project spec.
- See \`todo.md\` for the current task list.
- See \`AGENTS.md\` for how the AI assistant should behave.
EOF
fi

echo "ðŸ Bootstrap complete."
echo "  Next steps:"
echo "    - Activate venv: source .venv/bin/activate"
echo "    - Skim README.md, spec.md, and todo.md; edit as needed"
echo "    - Review AGENTS.md and start coding."
